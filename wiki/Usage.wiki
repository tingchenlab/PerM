#labels Featured
If you have any usage question, please email "yanghoch at usc.edu".

= CONTENTS ==  
== Compile == http://code.google.com/p/perm/wiki/Compile
== Output == http://code.google.com/p/perm/wiki/Output

== SYNOPSIS ==  
To use the command line, type PerM with the args in the order.
For single end read: {{{PerM <Ref> <Reads> [options]}}}
 * {{{./PerM Ref.fasta SingleEndReads.fasta -v 5 }}}
 * {{{./PerM RefFilesList.txt ReadsSetFilesList.txt -v 5 -u unmappedReads.fa -E }}}
 * {{{./PerM Ref.fasta SingleEndReads.csfasta -v 5 -m -s my.index --delimiter ',' --seed F3}}}
 * {{{./PerM my.index SingleEndReads.csfasta -v 5}}} 
For paired end read: {{{ PerM <Ref> -1 <F3_Reads> -2 <R3_Reads> [options] }}}
 * {{{./PerM ref.fa -1 F3.fa -2 R3.fa -U 3000 -L 100 -v 5 -A -m -s -o out.sam}}}
 * {{{./PerM ref.txt -1 F3.fq -2 R3.fq -v 5 -m -s my.index -o out.mapping --seed F3}}}
 * {{{./PerM my.index -1 F3.fq -2 R3.fq -U 3000 -L 100 -v 5 -A -o out.sam}}}
== Command Line Options ==  
The following are the short description for each arguments:
 # The reference file should be in fasta format with the corresponding ext name ex: .fasta, .fna. or .fa. For transcriptom with multiple genes or isoforms as reference, concatenate all fasta in a fasta file. Or, if there are many files, one for each chromosome, ex: chr1.fa to chrY.fa, list them in a .txt file, so PerM knows it is a file listing the path of multiple fasta file.  
 # The reads file should be in the .fasta, .fastq, .csfasta or .csfastq format. PerM parses a file according to it's ext file name, or the format specified by flag *--format <format>*. If there are multiple read files, list each file names in a .txt file, with each row a path of the reads file. PerM takes it as the input and can map multiple read sets in parallel by OpenMP. 
 # Mismatch threshold could be a integer 2 to 5. For reads over 64, PerM allows double the number of mismatches than the given threshold.
 # Options: By default, PerM outputs all the best alignments in terms of the mismatches number with in the threshold, end-to-end. It will try to use the saved indexes. If not found, reconstruct the indexes. The following option flags can change the default settings.
 * *-A*     Output all alignments within the mismatch threshold.
 * *-B*     Output best alignments in terms of mismatches in the threshold.(Default) 
 * *-E*     Output only the unique mapped reads. 
 * *-m*     Create the reference index, without reusing the saved index.
 * *-s P*     Save the reference index to accelerate the mapping in the future. If path P is not specify, the default path will be used. 
 * *-v I*  where I i the number of mismatches allowed in one end.
 * *-T I*, where I is tbe length to truncate read length, say 30 means use only first 30 
bases (signals). Don't put the number if the full read is meant to be used.
 * *-o P*, where P is the the output path for one read set. PerM's output are in .mapping or .sam format, determined by the ext name of P. 
 * *-d P*, where P is the the output dir for multip read set
 * *-u P*, Print the fasta(fastq) file of those unmapped reads to a file
 * *--ignoreQS* Ignore the quality scores in fastq or QUAL files.
 * *--seed {F2 | S11 | F3 | F4}* Use the specified seed pattern.
 * *--readFormat {fasta | fastq | csfasta | csfastq}*. Read in reads in the specified format, instead of gussing according to the ext name.
 * *--delimiter c, where c is a character which is used as the delimiter which is used to parse the read id. This is used for read set which attach additional information in the read id, using character ',', ':', '|' or other symbols. 

Ex:  ./PerM Ref.fa Reads.fa -v 5 -E -T 36 -m -s -o out.sam
PerM will report only the uniquely mapped reads within 5 mismatches in the first 36 bases.
PerM will reconstruct and save the indexes to the default path for future mappings.
PerM will output the mappings file to out.sam in the sam format.

The following is some detail description for each argument. 
====Reference Files====
PerM takes single or multiple fasta files as the reference. If there are multiple fasta files, make a list file, say {{{HumanGenome.txt}}}, with each fasta file name in a row, as the command line input example as the above. PerM also takes fasta with multiple sequences separated by a line start with "> Sequence Name", as input which typically is a transcripts or contigs. The first word after ">" will be used as a "Sequence Name", which will be showed with the corresponding alignments. Inside our program, sequences are concatenated and separated by "N", so no junction will be aligned. Only ACGT and N are allowed in the reference file. Other valid nucleotide symbol such as U, R, Y, M, K, S, W, B, D, H, V will be modified to "N". Note PerM concatenates the file names in the list to generate the file name for index. Limited by OS the system, the index file name couldn't be too long to be saved. 

====Read Files====
PerM expects reads from either the SOLiD or Solexa sequencer. PerM guesses the read file format according to the first read file's ext name, ex: ".fasta", ".fastq", ".csfasta", ".csfastq" ... etc. User can also use arg "--flag <readFormat> to specify the reads files format. Reads file format and the read lengths are assumed to be equal to the first read in the first data file. 

For SOLiD reads in csfasta format, PerM will try to read the file with the same base name as the read set, however with the ext name ".qual" for quality score. That is, if the read file name is 7B.csfasta, its quality file "7B.qual" should be put beside.
If quality score file is not available, or the reads and quality scores can't be matched, only the read sequences will be used. 

(Tips! Use our shell splitReads.sh to split fasta or csfasta file into one million reads per set. It will generate a list file. Use the list file name as the input ptr of PerM.) 

====Include or Exclude Ambiguous Mapping====
The default setting will print the best alignments for each read in term of mismatches number. Use "-E" to exclude the reads has multiple "best" alignments. Use "-A" flag if all alignments within substitution threshold are meant to be printed. A maximum 100 mapping per read will be print consecutively in the output file. 

=Output=
The summary of the mapping results are printed directly to the screen. They include the  number of reads mapped with each number of mismatches and the running time of each step. 
use " | tee mapping.log" to get the summary and "grep" for the statistics. 

==Index==
After version 0.1.8, PerM save references sequence in binary in the index. It requires 4.5 bytes (one integer + 4 bits) + 256M memory for mapping. As always, the memory and disk should have enough capacity. 

==Mapping Results==
PerM (version 0.1.7) can output in SAM format, by specify the flag -o `*`.sam.
For more information about sam format, check http://samtools.sourceforge.net/
User can do the down stream analysis using samtools. 

The original output format of has the ext name `*`.mapping. 

For single end read, each line is the result of a qualified mapping. 
The info in each line is read in the following order separated by tab:
  * Read Tag (Extract from the previous line of the reads input file. If the tag is missing, a fake tag will be used.)  
  * The read sequence. For SOLiD reads, the first base from the agent (not in the reference) is eliminated from display. The first color signal is translated into a base for display.
  * Chromosome Name or ID (begins at 0 and numbered according to the order in the reference list)
  * Chromosome Locus ID, the most left position on the reference. (Each chromosome has indexes starts from 0). 
  * The mapped reference sequence. (reversed-complemented if orientation is -). For SOLiD reads, this region is translated into colors for comparison to the read.
  * Positive (forward) or negative (backward) strand that the reads mapped to.
  * Number of mismatches or the mismatches score (the sum of quality scores in the mis-matched bases) if available. 
  * Number of mappings that this read aligns to, including the current one. 
  * Reads qualities, numbers printed in characters with a Illimina Quality score shift 

= Single End Paralleled Mapping =
PerM simultaneously maps multiple reads sets in a list by querying the same index. It will detect how many CPU (cores) are available and assign each CPU a read set, if available. If a read set is finished, the next read set in the list will be assigned to the available CPU automatically. Each read set will have its own output file `*`.mapping. To better utilize all CPUs on a node, large reads are suggested to be split to many small read sets and put in the list. 
When multiple nodes are used in the same file system, the index should be pre-built first by one node; the other node will read the pre-built index with out building index again. Without pre-built index, each machine will try to build their own index, wasting CPU hours and may cause insufficiency of disk quota. 

= Mate-paired Reads =
PerM deals with mate-paired reads by mapping each end separately. All combination of mated paired mapping in the same ref will be printed. Note this makes the running time become very slow, if both ends are in the repetitive regions. 

PerM takes two format of the paired end reads. 
(1) Concatenated 5'-3' end 3'-5' fasta file. 
(2) Two separated file of with _F3 and _R3. Each corresponding line is paired.
For input format (1), each file name should be listed in a row as single-end read file. 
For input format (2), the two paired files can be specified in a list, with each row having two files path, separated by . Ex: reads_F3.csfasta \t reads_R3.csfasta. 
Or, specified with the command line for a paired read files:
./PerM <reference or index path> -1 <forward reads path> -2 <reverse reads path> [-flag options]
(4)  Options for mate-paired reads:
-e     Exclude ambiguous paired. 
-L I   mate-paired separate lower bound
-U I   mate-paired separate upper bound, 
-o P   where P is the path (single paired read set) or the directory (multiple paired read sets)
The default is set as -L 0 -U 3000
The upper bound and lower bound can be negative, which may catch the re-arangement variations.
Ex:  ./PerM -1 F3.fq -2 R3.fq -U 500 -L 200 -m -s -o out.sam.
PerM will report only the non-ambiguous mate pair in the range of [200bp, 500bp]
PerM will reconstruct and save the indexes to the default path for future mappings.
PerM will output the mappings file to out.sam in the sam format.

= Limitation =
PerM doesn't support reads shorter than 25 base pairs. 
PerM doesn't support SOLiD reads with more than 64 base pair.
PerM doesn't support single-end Illumina reads with more than 128 base pair.
PerM doesn't support mate-paired Illumina reads with more than 64 base pair in each end.
We suggest users to set the truncated read length less than 64, using -T 64 to mapped long reads with their first 64 bases. 
A single reference sequence should be larger than the read length. We experience segmentation fault when trying map long reads to exons that is shorter than the read length. 

Currently, PerM will discard any reads with 'N'. Similarly, no reads will be mapped to any reference region with 'N'. This is the reason that users may experience that the total alignments founded by PerM is less than other mappers, given the same full sensitivity threshold. 